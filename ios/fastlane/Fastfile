default_platform(:ios)

platform :ios do
  desc "Upload prebuilt IPA to TestFlight"
  lane :upload_testflight do
    setup_ci

    ensure_app_store_key!
    api_key = app_store_api_key
    ipa_path = env_value("IOS_IPA_PATH", "../build/ios/ipa/vertochat.ipa")

    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
    )
  end

  desc "Upload prebuilt IPA to App Store (metadata/screenshots if present)"
  lane :upload_app_store do
    setup_ci

    ensure_app_store_key!
    api_key = app_store_api_key
    ipa_path = env_value("IOS_IPA_PATH", "../build/ios/ipa/vertochat.ipa")

    metadata_path = File.expand_path("metadata", __dir__)
    screenshots_path = File.expand_path("screenshots", __dir__)
    has_metadata = Dir.exist?(metadata_path) && !Dir.glob(File.join(metadata_path, "**", "*.txt")).empty?
    has_screenshots = Dir.exist?(screenshots_path) && !Dir.glob(File.join(screenshots_path, "**", "*.{png,jpg,jpeg}")).empty?

    upload_to_app_store(
      api_key: api_key,
      ipa: ipa_path,
      metadata_path: metadata_path,
      screenshots_path: screenshots_path,
      force: true,
      skip_metadata: !has_metadata,
      skip_screenshots: !has_screenshots,
      overwrite_screenshots: has_screenshots,
      submit_for_review: false,
      automatic_release: false,
    )
  end
end

def ensure_app_store_key!
  ensure_env_vars(
    env_vars: [
      "APP_STORE_CONNECT_API_KEY_ID",
      "APP_STORE_CONNECT_ISSUER_ID",
    ],
  )

  unless env_present?("APP_STORE_CONNECT_API_KEY_BASE64") || env_present?("APP_STORE_CONNECT_API_KEY")
    UI.user_error!("Missing App Store Connect API key content")
  end
end

def env_present?(key)
  !ENV[key].to_s.strip.empty?
end

def env_value(key, default_value = nil)
  value = ENV[key]
  return default_value if value.nil? || value.strip.empty?

  value
end

def app_store_api_key
  app_store_connect_api_key(
    key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
    issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
    key_content: env_value("APP_STORE_CONNECT_API_KEY_BASE64") || env_value("APP_STORE_CONNECT_API_KEY"),
    is_key_content_base64: env_present?("APP_STORE_CONNECT_API_KEY_BASE64"),
  )
end
